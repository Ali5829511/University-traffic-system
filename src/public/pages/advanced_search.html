<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث المتقدم - نظام إدارة المرور</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .search-panel {
            display: none;
        }

        .search-panel.active {
            display: block;
        }

        .search-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .results-container {
            margin-top: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .results-export {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            padding: 8px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            background: #667eea;
            color: white;
        }

        .btn-export.excel {
            border-color: #1D6F42;
            color: #1D6F42;
        }

        .btn-export.excel:hover {
            background: #1D6F42;
            color: white;
        }

        .btn-export.pdf {
            border-color: #c41e3a;
            color: #c41e3a;
        }

        .btn-export.pdf:hover {
            background: #c41e3a;
            color: white;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-table th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            text-align: right;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .no-results h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 8px 16px;
            color: #666;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 48px;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn-view {
            background: #17a2b8;
            color: white;
        }

        .action-btn-edit {
            background: #ffc107;
            color: white;
        }

        .action-btn-delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div style="text-align: right;">
                <h1><i class="fas fa-search"></i> البحث المتقدم</h1>
                <p>ابحث في قاعدة البيانات باستخدام فلاتر متقدمة</p>
            </div>
            <a href="home.html" class="btn btn-primary" style="text-decoration: none;">
                <i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية
            </a>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="violations">
                <i class="fas fa-car-crash"></i> المخالفات
            </button>
            <button class="tab" data-tab="vehicles">
                <i class="fas fa-car"></i> السيارات
            </button>
            <button class="tab" data-tab="users">
                <i class="fas fa-users"></i> المستخدمين
            </button>
        </div>

        <!-- Violations Search Panel -->
        <div id="violations-panel" class="search-panel active">
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-id-card"></i> رقم اللوحة</label>
                        <input type="text" id="v-plate" placeholder="أدخل رقم اللوحة">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-exclamation-triangle"></i> نوع المخالفة</label>
                        <select id="v-type">
                            <option value="">جميع الأنواع</option>
                            <option value="سرعة زائدة">سرعة زائدة</option>
                            <option value="وقوف خاطئ">وقوف خاطئ</option>
                            <option value="تجاوز خاطئ">تجاوز خاطئ</option>
                            <option value="استخدام الهاتف">استخدام الهاتف</option>
                            <option value="عدم ربط حزام الأمان">عدم ربط حزام الأمان</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> من تاريخ</label>
                        <input type="date" id="v-date-from">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> إلى تاريخ</label>
                        <input type="date" id="v-date-to">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> الموقع</label>
                        <input type="text" id="v-location" placeholder="أدخل الموقع">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-info-circle"></i> الحالة</label>
                        <select id="v-status">
                            <option value="">جميع الحالات</option>
                            <option value="نشط">نشط</option>
                            <option value="مسدد">مسدد</option>
                            <option value="ملغي">ملغي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-tie"></i> اسم الضابط</label>
                        <input type="text" id="v-officer" placeholder="أدخل اسم الضابط">
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="searchViolations()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn btn-secondary" onclick="resetViolationsForm()">
                        <i class="fas fa-redo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
            <div id="violations-results" class="results-container"></div>
        </div>

        <!-- Vehicles Search Panel -->
        <div id="vehicles-panel" class="search-panel">
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-id-card"></i> رقم اللوحة</label>
                        <input type="text" id="vh-plate" placeholder="أدخل رقم اللوحة">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> اسم المالك</label>
                        <input type="text" id="vh-owner" placeholder="أدخل اسم المالك">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-car"></i> نوع السيارة</label>
                        <select id="vh-type">
                            <option value="">جميع الأنواع</option>
                            <option value="سيدان">سيدان</option>
                            <option value="دفع رباعي">دفع رباعي</option>
                            <option value="شاحنة">شاحنة</option>
                            <option value="حافلة">حافلة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-palette"></i> اللون</label>
                        <input type="text" id="vh-color" placeholder="أدخل اللون">
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="searchVehicles()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn btn-secondary" onclick="resetVehiclesForm()">
                        <i class="fas fa-redo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
            <div id="vehicles-results" class="results-container"></div>
        </div>

        <!-- Users Search Panel -->
        <div id="users-panel" class="search-panel">
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> اسم المستخدم</label>
                        <input type="text" id="u-username" placeholder="أدخل اسم المستخدم">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-id-badge"></i> الاسم الكامل</label>
                        <input type="text" id="u-fullname" placeholder="أدخل الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                        <input type="email" id="u-email" placeholder="أدخل البريد الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-tag"></i> الدور</label>
                        <select id="u-role">
                            <option value="">جميع الأدوار</option>
                            <option value="admin">مدير النظام</option>
                            <option value="violations_officer">مسجل المخالفات</option>
                            <option value="inquiry_user">موظف الاستعلام</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-toggle-on"></i> الحالة</label>
                        <select id="u-active">
                            <option value="">جميع الحالات</option>
                            <option value="true">نشط</option>
                            <option value="false">غير نشط</option>
                        </select>
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="searchUsers()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn btn-secondary" onclick="resetUsersForm()">
                        <i class="fas fa-redo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
            <div id="users-results" class="results-container"></div>
        </div>
    </div>

    <script src="database-api.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active panel
                document.querySelectorAll('.search-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`${tabName}-panel`).classList.add('active');
            });
        });

        // Search Violations
        async function searchViolations() {
            const filters = {
                plate_number: document.getElementById('v-plate').value,
                violation_type: document.getElementById('v-type').value,
                date_from: document.getElementById('v-date-from').value,
                date_to: document.getElementById('v-date-to').value,
                location: document.getElementById('v-location').value,
                status: document.getElementById('v-status').value,
                officer_name: document.getElementById('v-officer').value,
                page: 1,
                limit: 50
            };

            // Remove empty filters
            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });

            const resultsDiv = document.getElementById('violations-results');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>جاري البحث...</p></div>';

            try {
                const response = await fetch('/api/violations/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayViolationsResults(data.data, data.pagination);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>لم يتم العثور على نتائج</h3>
                            <p>جرب تغيير معايير البحث</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>حدث خطأ أثناء البحث</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displayViolationsResults(data, pagination) {
            const resultsDiv = document.getElementById('violations-results');
            
            let html = `
                <div class="results-header">
                    <div class="results-count">
                        <i class="fas fa-list"></i> النتائج: ${data.length} من أصل ${pagination?.total || data.length}
                    </div>
                    <div class="results-export">
                        <button class="btn-export excel" onclick="exportViolationsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            تصدير Excel
                        </button>
                        <button class="btn-export pdf" onclick="exportViolationsToPDF()" title="يتم تصدير أول 100 سجل فقط">
                            <i class="fas fa-file-pdf"></i>
                            تصدير PDF
                        </button>
                    </div>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>رقم المخالفة</th>
                            <th>رقم اللوحة</th>
                            <th>نوع المخالفة</th>
                            <th>التاريخ</th>
                            <th>الموقع</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const statusClass = item.status === 'مسدد' ? 'success' : item.status === 'نشط' ? 'warning' : 'danger';
                html += `
                    <tr>
                        <td>${item.violation_number || '-'}</td>
                        <td><strong>${item.plate_number || '-'}</strong></td>
                        <td>${item.violation_type || '-'}</td>
                        <td>${item.violation_date || '-'}</td>
                        <td>${item.location || '-'}</td>
                        <td><span class="badge badge-${statusClass}">${item.status || 'نشط'}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn action-btn-view" onclick="viewViolation(${item.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }

        // Search Vehicles
        async function searchVehicles() {
            const filters = {
                plate_number: document.getElementById('vh-plate').value,
                owner_name: document.getElementById('vh-owner').value,
                vehicle_type: document.getElementById('vh-type').value,
                color: document.getElementById('vh-color').value,
                page: 1,
                limit: 50
            };

            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });

            const resultsDiv = document.getElementById('vehicles-results');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>جاري البحث...</p></div>';

            try {
                const response = await fetch('/api/vehicles/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayVehiclesResults(data.data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>لم يتم العثور على نتائج</h3>
                            <p>جرب تغيير معايير البحث</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>حدث خطأ أثناء البحث</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displayVehiclesResults(data) {
            const resultsDiv = document.getElementById('vehicles-results');
            
            let html = `
                <div class="results-header">
                    <div class="results-count">
                        <i class="fas fa-list"></i> النتائج: ${data.length}
                    </div>
                    <div class="results-export">
                        <button class="btn-export excel" onclick="exportVehiclesToExcel()">
                            <i class="fas fa-file-excel"></i>
                            تصدير Excel
                        </button>
                        <button class="btn-export pdf" onclick="exportVehiclesToPDF()" title="يتم تصدير أول 100 سجل فقط">
                            <i class="fas fa-file-pdf"></i>
                            تصدير PDF
                        </button>
                    </div>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>رقم اللوحة</th>
                            <th>اسم المالك</th>
                            <th>نوع السيارة</th>
                            <th>اللون</th>
                            <th>تاريخ التسجيل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td><strong>${item.plate_number || '-'}</strong></td>
                        <td>${item.owner_name || '-'}</td>
                        <td>${item.vehicle_type || '-'}</td>
                        <td>${item.color || '-'}</td>
                        <td>${new Date(item.created_at).toLocaleDateString('ar-SA')}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn action-btn-view" onclick="viewVehicle(${item.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }

        // Search Users
        async function searchUsers() {
            const filters = {
                username: document.getElementById('u-username').value,
                full_name: document.getElementById('u-fullname').value,
                email: document.getElementById('u-email').value,
                role: document.getElementById('u-role').value,
                is_active: document.getElementById('u-active').value ? document.getElementById('u-active').value === 'true' : undefined,
                page: 1,
                limit: 50
            };

            Object.keys(filters).forEach(key => {
                if (filters[key] === undefined || filters[key] === '') delete filters[key];
            });

            const resultsDiv = document.getElementById('users-results');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>جاري البحث...</p></div>';

            try {
                const response = await fetch('/api/users/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayUsersResults(data.data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>لم يتم العثور على نتائج</h3>
                            <p>جرب تغيير معايير البحث</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>حدث خطأ أثناء البحث</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displayUsersResults(data) {
            const resultsDiv = document.getElementById('users-results');
            
            let html = `
                <div class="results-header">
                    <div class="results-count">
                        <i class="fas fa-list"></i> النتائج: ${data.length}
                    </div>
                    <div class="results-export">
                        <button class="btn-export excel" onclick="exportUsersToExcel()">
                            <i class="fas fa-file-excel"></i>
                            تصدير Excel
                        </button>
                        <button class="btn-export pdf" onclick="exportUsersToPDF()" title="يتم تصدير أول 100 سجل فقط">
                            <i class="fas fa-file-pdf"></i>
                            تصدير PDF
                        </button>
                    </div>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>اسم المستخدم</th>
                            <th>الاسم الكامل</th>
                            <th>البريد الإلكتروني</th>
                            <th>الدور</th>
                            <th>الحالة</th>
                            <th>آخر تسجيل دخول</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const roleNames = {
                    'admin': 'مدير النظام',
                    'violations_officer': 'مسجل المخالفات',
                    'inquiry_user': 'موظف الاستعلام'
                };
                const statusClass = item.is_active ? 'success' : 'danger';
                html += `
                    <tr>
                        <td><strong>${item.username || '-'}</strong></td>
                        <td>${item.full_name || '-'}</td>
                        <td>${item.email || '-'}</td>
                        <td><span class="badge badge-info">${roleNames[item.role] || item.role}</span></td>
                        <td><span class="badge badge-${statusClass}">${item.is_active ? 'نشط' : 'غير نشط'}</span></td>
                        <td>${item.last_login ? new Date(item.last_login).toLocaleDateString('ar-SA') : 'لم يسجل دخول بعد'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }

        // Reset forms
        function resetViolationsForm() {
            document.getElementById('v-plate').value = '';
            document.getElementById('v-type').value = '';
            document.getElementById('v-date-from').value = '';
            document.getElementById('v-date-to').value = '';
            document.getElementById('v-location').value = '';
            document.getElementById('v-status').value = '';
            document.getElementById('v-officer').value = '';
            document.getElementById('violations-results').innerHTML = '';
        }

        function resetVehiclesForm() {
            document.getElementById('vh-plate').value = '';
            document.getElementById('vh-owner').value = '';
            document.getElementById('vh-type').value = '';
            document.getElementById('vh-color').value = '';
            document.getElementById('vehicles-results').innerHTML = '';
        }

        function resetUsersForm() {
            document.getElementById('u-username').value = '';
            document.getElementById('u-fullname').value = '';
            document.getElementById('u-email').value = '';
            document.getElementById('u-role').value = '';
            document.getElementById('u-active').value = '';
            document.getElementById('users-results').innerHTML = '';
        }

        function viewViolation(id) {
            window.location.href = `violation_details.html?id=${id}`;
        }

        function viewVehicle(id) {
            window.location.href = `vehicle_details.html?id=${id}`;
        }

        // ============================================
        // Helper Functions for Export
        // ============================================
        
        // Clean empty filters
        function cleanFilters(filters) {
            const cleaned = {};
            Object.keys(filters).forEach(key => {
                if (filters[key] !== undefined && filters[key] !== '') {
                    cleaned[key] = filters[key];
                }
            });
            return cleaned;
        }

        // Download file from blob
        function downloadBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Generic export function
        async function exportData(dataType, format, filters) {
            const cleanedFilters = cleanFilters(filters);
            
            try {
                const response = await fetch(`/api/export/${dataType}/${format}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanedFilters)
                });

                if (!response.ok) {
                    throw new Error(`فشل التصدير: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                const extension = format === 'excel' ? 'xlsx' : 'pdf';
                downloadBlob(blob, `${dataType}_${Date.now()}.${extension}`);
            } catch (error) {
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            }
        }

        // Get violations filters
        function getViolationsFilters() {
            return {
                plate_number: document.getElementById('v-plate').value,
                violation_type: document.getElementById('v-type').value,
                date_from: document.getElementById('v-date-from').value,
                date_to: document.getElementById('v-date-to').value,
                location: document.getElementById('v-location').value,
                status: document.getElementById('v-status').value,
                officer_name: document.getElementById('v-officer').value
            };
        }

        // Get vehicles filters
        function getVehiclesFilters() {
            return {
                plate_number: document.getElementById('vh-plate').value,
                owner_name: document.getElementById('vh-owner').value,
                vehicle_type: document.getElementById('vh-type').value,
                color: document.getElementById('vh-color').value
            };
        }

        // Get users filters
        function getUsersFilters() {
            const isActiveVal = document.getElementById('u-active').value;
            return {
                username: document.getElementById('u-username').value,
                full_name: document.getElementById('u-fullname').value,
                email: document.getElementById('u-email').value,
                role: document.getElementById('u-role').value,
                is_active: isActiveVal ? isActiveVal === 'true' : undefined
            };
        }

        // ============================================
        // Export Functions
        // ============================================
        
        // Export violations
        async function exportViolationsToExcel() {
            await exportData('violations', 'excel', getViolationsFilters());
        }

        async function exportViolationsToPDF() {
            await exportData('violations', 'pdf', getViolationsFilters());
        }

        // Export vehicles
        async function exportVehiclesToExcel() {
            await exportData('vehicles', 'excel', getVehiclesFilters());
        }

        async function exportVehiclesToPDF() {
            await exportData('vehicles', 'pdf', getVehiclesFilters());
        }

        // Export users
        async function exportUsersToExcel() {
            await exportData('users', 'excel', getUsersFilters());
        }

        async function exportUsersToPDF() {
            await exportData('users', 'pdf', getUsersFilters());
        }
    </script>

    <!-- تحميل مكتبات النظام -->
    <script src="/js/database.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // التحقق من تسجيل الدخول
        if (!window.authManager || !window.authManager.isAuthenticated()) {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
