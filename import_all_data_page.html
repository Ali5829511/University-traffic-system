<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استيراد جميع البيانات - نظام إدارة المرور</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Tajawal:wght@400;500;700&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background: linear-gradient(135deg, #003c50 0%, #00566f 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8B6F47;
        }

        .header h1 {
            font-size: 36px;
            color: #8B6F47;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 18px;
        }

        .data-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .data-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            border-right: 5px solid #8B6F47;
            transition: transform 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(139, 111, 71, 0.3);
        }

        .data-card h3 {
            color: #8B6F47;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-card .count {
            font-size: 48px;
            font-weight: bold;
            color: #003c50;
            text-align: center;
            margin: 20px 0;
        }

        .data-card .label {
            text-align: center;
            color: #666;
            font-size: 16px;
        }

        .data-card .status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.loading {
            background: #cce5ff;
            color: #004085;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-right: 5px solid #FF9800;
        }

        .warning-box h3 {
            color: #F57C00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-box p {
            color: #E65100;
            font-size: 16px;
            line-height: 1.6;
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: 'Tajawal', Arial, sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 56, 39, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8B6F47, #A0826D);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 111, 71, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-status {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-top: 10px;
        }

        .log-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .log-container.active {
            display: block;
        }

        .log-entry {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .log-entry.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-entry.success {
            background: #d4edda;
            color: #155724;
        }

        .log-entry.error {
            background: #f8d7da;
            color: #721c24;
        }

        .summary-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border-right: 5px solid #2196F3;
            display: none;
        }

        .summary-box.active {
            display: block;
        }

        .summary-box h3 {
            color: #1976D2;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-item .value {
            font-size: 32px;
            font-weight: bold;
            color: #1976D2;
        }

        .summary-item .label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-database"></i>
                استيراد جميع البيانات
            </h1>
            <p>Import All Data from Excel Files</p>
        </div>

        <div class="warning-box">
            <h3>
                <i class="fas fa-exclamation-triangle"></i>
                تحذير هام
            </h3>
            <p>
                سيتم حذف جميع البيانات القديمة واستبدالها بالبيانات الجديدة من ملفات Excel!
                <br>
                هذه العملية لا يمكن التراجع عنها. يرجى التأكد من عمل نسخة احتياطية قبل المتابعة.
            </p>
        </div>

        <div class="data-sections" id="dataCards">
            <div class="data-card" id="card-stickers">
                <h3><i class="fas fa-ticket-alt"></i> الملصقات</h3>
                <div class="count" id="count-stickers">-</div>
                <div class="label">ملصق</div>
                <div class="status pending" id="status-stickers">في انتظار التحميل</div>
            </div>

            <div class="data-card" id="card-parking">
                <h3><i class="fas fa-parking"></i> المواقف</h3>
                <div class="count" id="count-parking">-</div>
                <div class="label">موقف</div>
                <div class="status pending" id="status-parking">في انتظار التحميل</div>
            </div>

            <div class="data-card" id="card-units">
                <h3><i class="fas fa-home"></i> الوحدات السكنية</h3>
                <div class="count" id="count-units">-</div>
                <div class="label">وحدة</div>
                <div class="status pending" id="status-units">في انتظار التحميل</div>
            </div>

            <div class="data-card" id="card-residents">
                <h3><i class="fas fa-users"></i> السكان</h3>
                <div class="count" id="count-residents">-</div>
                <div class="label">ساكن</div>
                <div class="status pending" id="status-residents">في انتظار التحميل</div>
            </div>

            <div class="data-card" id="card-buildings">
                <h3><i class="fas fa-building"></i> المباني</h3>
                <div class="count" id="count-buildings">-</div>
                <div class="label">مبنى</div>
                <div class="status pending" id="status-buildings">في انتظار التحميل</div>
            </div>
        </div>

        <div class="buttons-container">
            <button class="btn btn-primary" onclick="loadPreview()" id="previewBtn">
                <i class="fas fa-eye"></i>
                معاينة البيانات
            </button>
            <button class="btn btn-danger" onclick="confirmImport()" id="importBtn" disabled>
                <i class="fas fa-download"></i>
                استيراد جميع البيانات
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='home.html'">
                <i class="fas fa-home"></i>
                العودة للرئيسية
            </button>
        </div>

        <div class="progress-container" id="progressBox">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div class="progress-status" id="progressStatus">جاري التحضير...</div>
        </div>

        <div class="log-container" id="logContainer"></div>

        <div class="summary-box" id="summaryBox">
            <h3><i class="fas fa-check-circle"></i> ملخص الاستيراد</h3>
            <div class="summary-grid" id="summaryGrid"></div>
        </div>
    </div>

    <script>
        let allData = {};
        let importComplete = false;

        function updateCardStatus(type, status, count = null) {
            const statusEl = document.getElementById(`status-${type}`);
            const countEl = document.getElementById(`count-${type}`);
            
            statusEl.className = `status ${status}`;
            
            if (count !== null) {
                countEl.textContent = count.toLocaleString('ar-SA');
            }
            
            const statusText = {
                pending: 'في انتظار التحميل',
                loading: 'جاري التحميل...',
                success: 'تم التحميل ✓',
                error: 'خطأ في التحميل ✗'
            };
            
            statusEl.textContent = statusText[status] || status;
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            logContainer.classList.add('active');
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ar-SA')}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(percent, status) {
            const fill = document.getElementById('progressFill');
            const statusEl = document.getElementById('progressStatus');
            
            fill.style.width = `${percent}%`;
            fill.textContent = `${percent}%`;
            statusEl.textContent = status;
        }

        async function loadPreview() {
            const progressBox = document.getElementById('progressBox');
            progressBox.classList.add('active');
            document.getElementById('logContainer').classList.add('active');
            
            try {
                updateProgress(0, 'بدء تحميل البيانات...');
                addLog('بدء معاينة البيانات من الملفات', 'info');
                
                // Load Stickers
                updateProgress(10, 'تحميل بيانات الملصقات...');
                updateCardStatus('stickers', 'loading');
                const stickersRes = await fetch('stickers_data.json');
                allData.stickers = await stickersRes.json();
                updateCardStatus('stickers', 'success', allData.stickers.metadata.totalCount);
                addLog(`✓ تم تحميل ${allData.stickers.metadata.totalCount} ملصق`, 'success');
                
                // Load Parking
                updateProgress(30, 'تحميل بيانات المواقف...');
                updateCardStatus('parking', 'loading');
                const parkingRes = await fetch('parking_data.json');
                allData.parking = await parkingRes.json();
                updateCardStatus('parking', 'success', allData.parking.metadata.totalCount);
                addLog(`✓ تم تحميل ${allData.parking.metadata.totalCount} موقف`, 'success');
                
                // Load Units
                updateProgress(50, 'تحميل بيانات الوحدات السكنية...');
                updateCardStatus('units', 'loading');
                const unitsRes = await fetch('residential_units_data.json');
                allData.units = await unitsRes.json();
                updateCardStatus('units', 'success', allData.units.metadata.totalCount);
                addLog(`✓ تم تحميل ${allData.units.metadata.totalCount} وحدة سكنية`, 'success');
                
                // Load Residents
                updateProgress(70, 'تحميل بيانات السكان...');
                updateCardStatus('residents', 'loading');
                const residentsRes = await fetch('residents_data.json');
                allData.residents = await residentsRes.json();
                updateCardStatus('residents', 'success', allData.residents.metadata.totalCount);
                addLog(`✓ تم تحميل ${allData.residents.metadata.totalCount} ساكن`, 'success');
                
                // Load Buildings
                updateProgress(90, 'تحميل بيانات المباني...');
                updateCardStatus('buildings', 'loading');
                const buildingsRes = await fetch('buildings_data.json');
                allData.buildings = await buildingsRes.json();
                updateCardStatus('buildings', 'success', allData.buildings.metadata.totalCount);
                addLog(`✓ تم تحميل ${allData.buildings.metadata.totalCount} مبنى`, 'success');
                
                updateProgress(100, 'تم التحميل بنجاح!');
                addLog('تم تحميل جميع البيانات بنجاح!', 'success');
                
                // Enable import button
                document.getElementById('importBtn').disabled = false;
                
                const totalRecords = 
                    allData.stickers.metadata.totalCount +
                    allData.parking.metadata.totalCount +
                    allData.units.metadata.totalCount +
                    allData.residents.metadata.totalCount +
                    allData.buildings.metadata.totalCount;
                
                addLog(`إجمالي السجلات: ${totalRecords.toLocaleString('ar-SA')}`, 'success');
                addLog('يمكنك الآن استيراد البيانات بالضغط على زر "استيراد جميع البيانات"', 'info');
                
            } catch (error) {
                addLog(`خطأ: ${error.message}`, 'error');
                console.error('Error loading preview:', error);
            } finally {
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 2000);
            }
        }

        function confirmImport() {
            if (!allData.stickers) {
                addLog('يرجى معاينة البيانات أولاً!', 'error');
                return;
            }
            
            const totalRecords = 
                allData.stickers.metadata.totalCount +
                allData.parking.metadata.totalCount +
                allData.units.metadata.totalCount +
                allData.residents.metadata.totalCount +
                allData.buildings.metadata.totalCount;
            
            const confirmed = confirm(
                `هل أنت متأكد من استيراد ${totalRecords.toLocaleString('ar-SA')} سجل؟\n\n` +
                `سيتم حذف جميع البيانات القديمة!\n\n` +
                `هذه العملية لا يمكن التراجع عنها.`
            );
            
            if (confirmed) {
                importAllData();
            }
        }

        async function importAllData() {
            const progressBox = document.getElementById('progressBox');
            progressBox.classList.add('active');
            
            try {
                updateProgress(10, 'جاري حذف البيانات القديمة...');
                addLog('بدء عملية الاستيراد...', 'info');
                addLog('حذف البيانات القديمة...', 'info');
                
                // Clear old data
                localStorage.removeItem('stickers');
                localStorage.removeItem('stickersMetadata');
                localStorage.removeItem('parkingSpaces');
                localStorage.removeItem('residentialUnits');
                localStorage.removeItem('residents');
                localStorage.removeItem('buildings');
                
                addLog('✓ تم حذف البيانات القديمة', 'success');
                
                // Import new data
                updateProgress(30, 'استيراد بيانات الملصقات...');
                localStorage.setItem('stickers', JSON.stringify(allData.stickers.stickers));
                localStorage.setItem('stickersMetadata', JSON.stringify(allData.stickers.metadata));
                addLog('✓ تم استيراد بيانات الملصقات', 'success');
                
                updateProgress(45, 'استيراد بيانات المواقف...');
                localStorage.setItem('parkingSpaces', JSON.stringify(allData.parking.parkingSpaces));
                addLog('✓ تم استيراد بيانات المواقف', 'success');
                
                updateProgress(60, 'استيراد بيانات الوحدات السكنية...');
                localStorage.setItem('residentialUnits', JSON.stringify(allData.units.residentialUnits));
                addLog('✓ تم استيراد بيانات الوحدات السكنية', 'success');
                
                updateProgress(75, 'استيراد بيانات السكان...');
                localStorage.setItem('residents', JSON.stringify(allData.residents.residents));
                addLog('✓ تم استيراد بيانات السكان', 'success');
                
                updateProgress(90, 'استيراد بيانات المباني...');
                localStorage.setItem('buildings', JSON.stringify(allData.buildings.buildings));
                addLog('✓ تم استيراد بيانات المباني', 'success');
                
                updateProgress(100, 'تم الاستيراد بنجاح!');
                addLog('تم استيراد جميع البيانات بنجاح!', 'success');
                
                // Show summary
                showSummary();
                
                // Disable import button
                document.getElementById('importBtn').disabled = true;
                importComplete = true;
                
                setTimeout(() => {
                    if (confirm('تم الاستيراد بنجاح! هل تريد الانتقال إلى الصفحة الرئيسية؟')) {
                        window.location.href = 'home.html';
                    }
                }, 2000);
                
            } catch (error) {
                addLog(`خطأ: ${error.message}`, 'error');
                console.error('Error importing data:', error);
            } finally {
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 3000);
            }
        }

        function showSummary() {
            const summaryBox = document.getElementById('summaryBox');
            const summaryGrid = document.getElementById('summaryGrid');
            
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="value">${allData.stickers.metadata.totalCount.toLocaleString('ar-SA')}</div>
                    <div class="label">ملصق</div>
                </div>
                <div class="summary-item">
                    <div class="value">${allData.parking.metadata.totalCount.toLocaleString('ar-SA')}</div>
                    <div class="label">موقف</div>
                </div>
                <div class="summary-item">
                    <div class="value">${allData.units.metadata.totalCount.toLocaleString('ar-SA')}</div>
                    <div class="label">وحدة سكنية</div>
                </div>
                <div class="summary-item">
                    <div class="value">${allData.residents.metadata.totalCount.toLocaleString('ar-SA')}</div>
                    <div class="label">ساكن</div>
                </div>
                <div class="summary-item">
                    <div class="value">${allData.buildings.metadata.totalCount.toLocaleString('ar-SA')}</div>
                    <div class="label">مبنى</div>
                </div>
            `;
            
            summaryBox.classList.add('active');
        }

        // Initial message
        window.addEventListener('load', () => {
            addLog('مرحباً بك في صفحة استيراد جميع البيانات', 'info');
            addLog('قم بالضغط على "معاينة البيانات" لعرض البيانات قبل الاستيراد', 'info');
        });
    </script>
</body>
</html>
